---
source: crates/redoubt-vault/derive/src/tests/expand.rs
expression: pretty(token_stream)
---
struct Container<T>
where
    T: redoubt_codec::BytesRequired + redoubt_codec::Encode + redoubt_codec::Decode,
{
    pub value: T,
    pub count: u64,
    #[codec(default)]
    __sentinel: redoubt_zero::ZeroizeOnDropSentinel,
}
use redoubt_vault_core::CipherBoxDyns as _;
impl<T> redoubt_vault_core::CipherBoxDyns<2> for Container<T>
where
    T: redoubt_codec::BytesRequired + redoubt_codec::Encode + redoubt_codec::Decode,
{
    fn to_encryptable_dyn_fields(
        &mut self,
    ) -> [&mut dyn redoubt_vault_core::Encryptable; 2] {
        [&mut self.value, &mut self.count]
    }
    fn to_decryptable_dyn_fields(
        &mut self,
    ) -> [&mut dyn redoubt_vault_core::Decryptable; 2] {
        [&mut self.value, &mut self.count]
    }
}
impl<A: redoubt_aead::AeadApi> redoubt_vault_core::EncryptStruct<A, 2> for Container<T>
where
    T: redoubt_codec::BytesRequired + redoubt_codec::Encode + redoubt_codec::Decode,
{
    fn encrypt_into(
        &mut self,
        aead: &mut A,
        aead_key: &[u8],
        nonces: &mut [Vec<u8>; 2],
        tags: &mut [Vec<u8>; 2],
    ) -> Result<[Vec<u8>; 2], redoubt_vault_core::CipherBoxError> {
        redoubt_vault_core::encrypt_into(
            self.to_encryptable_dyn_fields(),
            aead,
            aead_key,
            nonces,
            tags,
        )
    }
}
impl<A: redoubt_aead::AeadApi> redoubt_vault_core::DecryptStruct<A, 2> for Container<T>
where
    T: redoubt_codec::BytesRequired + redoubt_codec::Encode + redoubt_codec::Decode,
{
    fn decrypt_from(
        &mut self,
        aead: &mut A,
        aead_key: &[u8],
        nonces: &mut [Vec<u8>; 2],
        tags: &mut [Vec<u8>; 2],
        ciphertexts: &mut [Vec<u8>; 2],
    ) -> Result<(), redoubt_vault_core::CipherBoxError> {
        redoubt_vault_core::decrypt_from(
            &mut self.to_decryptable_dyn_fields(),
            aead,
            aead_key,
            nonces,
            tags,
            ciphertexts,
        )
    }
}
pub struct ContainerBox {
    inner: redoubt_vault_core::CipherBox<Container, redoubt_aead::Aead, 2>,
}
impl ContainerBox {
    #[inline(always)]
    pub fn new() -> Self {
        Self {
            inner: redoubt_vault_core::CipherBox::new(redoubt_aead::Aead::new()),
        }
    }
    #[inline(always)]
    pub fn open<F, R>(&mut self, f: F) -> Result<R, redoubt_vault_core::CipherBoxError>
    where
        F: Fn(&Container) -> Result<R, redoubt_vault_core::CipherBoxError>,
    {
        self.inner.open(f)
    }
    #[inline(always)]
    pub fn open_mut<F, R>(
        &mut self,
        f: F,
    ) -> Result<R, redoubt_vault_core::CipherBoxError>
    where
        F: Fn(&mut Container) -> Result<R, redoubt_vault_core::CipherBoxError>,
    {
        self.inner.open_mut(f)
    }
    #[inline(always)]
    pub fn leak_value(
        &mut self,
    ) -> Result<redoubt_zero::ZeroizingGuard<T>, redoubt_vault_core::CipherBoxError> {
        self.inner.leak_field::<T, 0, redoubt_vault_core::CipherBoxError>()
    }
    #[inline(always)]
    pub fn leak_count(
        &mut self,
    ) -> Result<redoubt_zero::ZeroizingGuard<u64>, redoubt_vault_core::CipherBoxError> {
        self.inner.leak_field::<u64, 1, redoubt_vault_core::CipherBoxError>()
    }
    #[inline(always)]
    pub fn open_value<F, R>(
        &mut self,
        f: F,
    ) -> Result<R, redoubt_vault_core::CipherBoxError>
    where
        F: Fn(&T) -> Result<R, redoubt_vault_core::CipherBoxError>,
    {
        self.inner.open_field::<T, 0, F, R, redoubt_vault_core::CipherBoxError>(f)
    }
    #[inline(always)]
    pub fn open_count<F, R>(
        &mut self,
        f: F,
    ) -> Result<R, redoubt_vault_core::CipherBoxError>
    where
        F: Fn(&u64) -> Result<R, redoubt_vault_core::CipherBoxError>,
    {
        self.inner.open_field::<u64, 1, F, R, redoubt_vault_core::CipherBoxError>(f)
    }
    #[inline(always)]
    pub fn open_value_mut<F, R>(
        &mut self,
        f: F,
    ) -> Result<R, redoubt_vault_core::CipherBoxError>
    where
        F: Fn(&mut T) -> Result<R, redoubt_vault_core::CipherBoxError>,
    {
        self.inner.open_field_mut::<T, 0, F, R, redoubt_vault_core::CipherBoxError>(f)
    }
    #[inline(always)]
    pub fn open_count_mut<F, R>(
        &mut self,
        f: F,
    ) -> Result<R, redoubt_vault_core::CipherBoxError>
    where
        F: Fn(&mut u64) -> Result<R, redoubt_vault_core::CipherBoxError>,
    {
        self.inner.open_field_mut::<u64, 1, F, R, redoubt_vault_core::CipherBoxError>(f)
    }
}
impl Default for ContainerBox {
    fn default() -> Self {
        Self::new()
    }
}
