FROM redoubt-test-base:latest

# Build workspace and dependencies in release mode with cache mount
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/workspace/target \
    cargo test --release --workspace --all-features --no-run

# Copy actual source code
COPY crates ./crates
COPY examples ./examples
COPY forensics ./forensics

# Update timestamps to force workspace re-compilation but keep dep artifacts
RUN find crates examples forensics -type f -name "*.rs" -exec touch {} \;

# Run release tests
CMD ["cargo", "test", "--release", "--workspace", "--all-features", "--", "--nocapture"]
