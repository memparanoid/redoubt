FROM rust:alpine

RUN apk add --no-cache \
  musl-dev \
  linux-headers \
  build-base \
  bash \
  libseccomp-dev \
  libseccomp-static

# Install cargo-make for linting
RUN cargo install cargo-make

WORKDIR /workspace

# Copy workspace Cargo.toml, Cargo.lock, and Makefile.toml
COPY Cargo.toml Cargo.lock Makefile.toml ./

# Copy all crate Cargo.toml files
COPY crates/redoubt-guard/Cargo.toml ./crates/redoubt-guard/
COPY crates/redoubt-alloc/Cargo.toml ./crates/redoubt-alloc/
COPY crates/redoubt-zero/Cargo.toml ./crates/redoubt-zero/
COPY crates/redoubt-zero/core/Cargo.toml ./crates/redoubt-zero/core/
COPY crates/redoubt-zero/derive/Cargo.toml ./crates/redoubt-zero/derive/
COPY crates/redoubt-secret/Cargo.toml ./crates/redoubt-secret/
COPY crates/redoubt-rand/Cargo.toml ./crates/redoubt-rand/
COPY crates/redoubt-util/Cargo.toml ./crates/redoubt-util/
COPY crates/redoubt-vault/Cargo.toml ./crates/redoubt-vault/
COPY crates/redoubt-vault/core/Cargo.toml ./crates/redoubt-vault/core/
COPY crates/redoubt-vault/derive/Cargo.toml ./crates/redoubt-vault/derive/
COPY crates/redoubt-aead/Cargo.toml ./crates/redoubt-aead/
COPY benchmarks/Cargo.toml ./benchmarks/
COPY crates/redoubt-codec/Cargo.toml ./crates/redoubt-codec/
COPY crates/redoubt-codec/core/Cargo.toml ./crates/redoubt-codec/core/
COPY crates/redoubt-codec/derive/Cargo.toml ./crates/redoubt-codec/derive/
COPY crates/redoubt-buffer/Cargo.toml ./crates/redoubt-buffer/
COPY crates/redoubt-test-utils/Cargo.toml ./crates/redoubt-test-utils/
COPY examples/wasm-demo/rust/Cargo.toml ./examples/wasm-demo/rust/

# Create stub lib.rs files to satisfy cargo build
RUN mkdir -p crates/redoubt-guard/src && echo "// stub" > crates/redoubt-guard/src/lib.rs && \
    mkdir -p crates/redoubt-alloc/src && echo "// stub" > crates/redoubt-alloc/src/lib.rs && \
    mkdir -p crates/redoubt-zero/src && echo "// stub" > crates/redoubt-zero/src/lib.rs && \
    mkdir -p crates/redoubt-zero/core/src && echo "// stub" > crates/redoubt-zero/core/src/lib.rs && \
    mkdir -p crates/redoubt-zero/derive/src && echo "// stub" > crates/redoubt-zero/derive/src/lib.rs && \
    mkdir -p crates/redoubt-secret/src && echo "// stub" > crates/redoubt-secret/src/lib.rs && \
    mkdir -p crates/redoubt-rand/src && echo "// stub" > crates/redoubt-rand/src/lib.rs && \
    mkdir -p crates/redoubt-util/src && echo "// stub" > crates/redoubt-util/src/lib.rs && \
    mkdir -p crates/redoubt-vault/src && echo "// stub" > crates/redoubt-vault/src/lib.rs && \
    mkdir -p crates/redoubt-vault/core/src && echo "// stub" > crates/redoubt-vault/core/src/lib.rs && \
    mkdir -p crates/redoubt-vault/derive/src && echo "// stub" > crates/redoubt-vault/derive/src/lib.rs && \
    mkdir -p crates/redoubt-aead/src && echo "// stub" > crates/redoubt-aead/src/lib.rs && \
    mkdir -p benchmarks/benches && echo "fn main() {}" > benchmarks/benches/aegis128l.rs && \
    echo "fn main() {}" > benchmarks/benches/xchacha20poly1305.rs && \
    echo "fn main() {}" > benchmarks/benches/codec.rs && \
    echo "fn main() {}" > benchmarks/benches/cipherbox.rs && \
    echo "fn main() {}" > benchmarks/benches/page_buffer.rs && \
    mkdir -p crates/redoubt-codec/src && echo "// stub" > crates/redoubt-codec/src/lib.rs && \
    mkdir -p crates/redoubt-codec/core/src && echo "// stub" > crates/redoubt-codec/core/src/lib.rs && \
    mkdir -p crates/redoubt-codec/derive/src && echo "// stub" > crates/redoubt-codec/derive/src/lib.rs && \
    mkdir -p crates/redoubt-buffer/src && echo "// stub" > crates/redoubt-buffer/src/lib.rs && \
    mkdir -p crates/redoubt-test-utils/src && echo "// stub" > crates/redoubt-test-utils/src/lib.rs && \
    mkdir -p examples/wasm-demo/rust/src && echo "// stub" > examples/wasm-demo/rust/src/lib.rs

# Build workspace and dependencies with cache mount
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/workspace/target \
    cargo test --workspace --all-targets --no-run

# Copy actual source code
COPY crates ./crates
COPY examples ./examples

# Update timestamps to force workspace re-compilation but keep dep artifacts
RUN find crates examples -type f -name "*.rs" -exec touch {} \;

# Entrypoint script
COPY docker/test-entrypoint.sh /usr/local/bin/test-entrypoint.sh
RUN chmod +x /usr/local/bin/test-entrypoint.sh

ENTRYPOINT ["/usr/local/bin/test-entrypoint.sh"]
