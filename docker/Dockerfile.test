FROM rust:1.83-slim

# Install required system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Copy workspace files
COPY . .

# Build all crates
RUN cargo build --all-features --workspace

# Run tests with required capabilities
# Note: This container needs --cap-add=IPC_LOCK to test mlock
CMD ["cargo", "test", "--all-features", "--workspace", "--", "--nocapture"]
