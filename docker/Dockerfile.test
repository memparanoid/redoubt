FROM rust:alpine

RUN apk add --no-cache \
  musl-dev \
  linux-headers \
  build-base \
  bash \
  libseccomp-dev \
  libseccomp-static

# Install cargo-make for linting
RUN cargo install cargo-make

WORKDIR /workspace

# Copy workspace Cargo.toml, Cargo.lock, and Makefile.toml
COPY Cargo.toml Cargo.lock Makefile.toml ./

# Copy all crate Cargo.toml files
COPY crates/memguard/Cargo.toml ./crates/memguard/
COPY crates/memalloc/Cargo.toml ./crates/memalloc/
COPY crates/memzer/Cargo.toml ./crates/memzer/
COPY crates/memzer/core/Cargo.toml ./crates/memzer/core/
COPY crates/memzer/derive/Cargo.toml ./crates/memzer/derive/
COPY crates/memsecret/Cargo.toml ./crates/memsecret/
COPY crates/memrand/Cargo.toml ./crates/memrand/
COPY crates/redoubt-util/Cargo.toml ./crates/redoubt-util/
COPY crates/memvault/Cargo.toml ./crates/memvault/
COPY crates/memvault/core/Cargo.toml ./crates/memvault/core/
COPY crates/memvault/derive/Cargo.toml ./crates/memvault/derive/
COPY crates/memaead/Cargo.toml ./crates/memaead/
COPY benchmarks/Cargo.toml ./benchmarks/
COPY crates/memcodec/Cargo.toml ./crates/memcodec/
COPY crates/memcodec/core/Cargo.toml ./crates/memcodec/core/
COPY crates/memcodec/derive/Cargo.toml ./crates/memcodec/derive/
COPY crates/membuffer/Cargo.toml ./crates/membuffer/
COPY crates/mem_test_utils/Cargo.toml ./crates/mem_test_utils/
COPY examples/wasm-demo/rust/Cargo.toml ./examples/wasm-demo/rust/

# Create stub lib.rs files to satisfy cargo build
RUN mkdir -p crates/memguard/src && echo "// stub" > crates/memguard/src/lib.rs && \
    mkdir -p crates/memalloc/src && echo "// stub" > crates/memalloc/src/lib.rs && \
    mkdir -p crates/memzer/src && echo "// stub" > crates/memzer/src/lib.rs && \
    mkdir -p crates/memzer/core/src && echo "// stub" > crates/memzer/core/src/lib.rs && \
    mkdir -p crates/memzer/derive/src && echo "// stub" > crates/memzer/derive/src/lib.rs && \
    mkdir -p crates/memsecret/src && echo "// stub" > crates/memsecret/src/lib.rs && \
    mkdir -p crates/memrand/src && echo "// stub" > crates/memrand/src/lib.rs && \
    mkdir -p crates/redoubt-util/src && echo "// stub" > crates/redoubt-util/src/lib.rs && \
    mkdir -p crates/memvault/src && echo "// stub" > crates/memvault/src/lib.rs && \
    mkdir -p crates/memvault/core/src && echo "// stub" > crates/memvault/core/src/lib.rs && \
    mkdir -p crates/memvault/derive/src && echo "// stub" > crates/memvault/derive/src/lib.rs && \
    mkdir -p crates/memaead/src && echo "// stub" > crates/memaead/src/lib.rs && \
    mkdir -p benchmarks/benches && echo "fn main() {}" > benchmarks/benches/aegis128l.rs && \
    echo "fn main() {}" > benchmarks/benches/xchacha20poly1305.rs && \
    echo "fn main() {}" > benchmarks/benches/memcodec.rs && \
    echo "fn main() {}" > benchmarks/benches/cipherbox.rs && \
    echo "fn main() {}" > benchmarks/benches/page_buffer.rs && \
    mkdir -p crates/memcodec/src && echo "// stub" > crates/memcodec/src/lib.rs && \
    mkdir -p crates/memcodec/core/src && echo "// stub" > crates/memcodec/core/src/lib.rs && \
    mkdir -p crates/memcodec/derive/src && echo "// stub" > crates/memcodec/derive/src/lib.rs && \
    mkdir -p crates/membuffer/src && echo "// stub" > crates/membuffer/src/lib.rs && \
    mkdir -p crates/mem_test_utils/src && echo "// stub" > crates/mem_test_utils/src/lib.rs && \
    mkdir -p examples/wasm-demo/rust/src && echo "// stub" > examples/wasm-demo/rust/src/lib.rs

# Build workspace and dependencies with cache mount
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/workspace/target \
    cargo test --workspace --all-targets --no-run

# Copy actual source code
COPY crates ./crates
COPY examples ./examples

# Update timestamps to force workspace re-compilation but keep dep artifacts
RUN find crates examples -type f -name "*.rs" -exec touch {} \;

# Entrypoint script
COPY docker/test-entrypoint.sh /usr/local/bin/test-entrypoint.sh
RUN chmod +x /usr/local/bin/test-entrypoint.sh

ENTRYPOINT ["/usr/local/bin/test-entrypoint.sh"]
