# Cross-architecture test for memcodec_core, memaead, memutil
# Usage:
#   docker build --platform linux/amd64 -f docker/Dockerfile.arch-test -t memora-test-x86 .
#   docker build --platform linux/arm64 -f docker/Dockerfile.arch-test -t memora-test-arm .
#   docker build --platform linux/s390x -f docker/Dockerfile.arch-test -t memora-test-be .

FROM rust:bookworm

RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

# Copy workspace Cargo.toml and Cargo.lock
COPY Cargo.toml Cargo.lock ./

# Copy only the crates we need to test + their dependencies
COPY crates/memprotect/Cargo.toml ./crates/memprotect/
COPY crates/memalloc/Cargo.toml ./crates/memalloc/
COPY crates/membuffer/Cargo.toml ./crates/membuffer/
COPY crates/memzer/Cargo.toml ./crates/memzer/
COPY crates/memzer/core/Cargo.toml ./crates/memzer/core/
COPY crates/memzer/derive/Cargo.toml ./crates/memzer/derive/
COPY crates/memrand/Cargo.toml ./crates/memrand/
COPY crates/memutil/Cargo.toml ./crates/memutil/
COPY crates/memaead/Cargo.toml ./crates/memaead/
COPY crates/memcodec/Cargo.toml ./crates/memcodec/
COPY crates/memcodec/core/Cargo.toml ./crates/memcodec/core/
COPY crates/memcodec/derive/Cargo.toml ./crates/memcodec/derive/

# Stub crates we don't need but are in workspace
COPY crates/memcode/Cargo.toml ./crates/memcode/
COPY crates/memcode/core/Cargo.toml ./crates/memcode/core/
COPY crates/memcode/derive/Cargo.toml ./crates/memcode/derive/
COPY crates/memsecret/Cargo.toml ./crates/memsecret/
COPY crates/memvault/Cargo.toml ./crates/memvault/
COPY crates/memcrypt/Cargo.toml ./crates/memcrypt/
COPY crates/membench/Cargo.toml ./crates/membench/

# Create stub lib.rs files
RUN mkdir -p crates/memprotect/src && echo "// stub" > crates/memprotect/src/lib.rs && \
    mkdir -p crates/memalloc/src && echo "// stub" > crates/memalloc/src/lib.rs && \
    mkdir -p crates/membuffer/src && echo "// stub" > crates/membuffer/src/lib.rs && \
    mkdir -p crates/memzer/src && echo "// stub" > crates/memzer/src/lib.rs && \
    mkdir -p crates/memzer/core/src && echo "// stub" > crates/memzer/core/src/lib.rs && \
    mkdir -p crates/memzer/derive/src && echo "// stub" > crates/memzer/derive/src/lib.rs && \
    mkdir -p crates/memrand/src && echo "// stub" > crates/memrand/src/lib.rs && \
    mkdir -p crates/memutil/src && echo "// stub" > crates/memutil/src/lib.rs && \
    mkdir -p crates/memaead/src && echo "// stub" > crates/memaead/src/lib.rs && \
    mkdir -p crates/memcodec/src && echo "// stub" > crates/memcodec/src/lib.rs && \
    mkdir -p crates/memcodec/core/src && echo "// stub" > crates/memcodec/core/src/lib.rs && \
    mkdir -p crates/memcodec/derive/src && echo "// stub" > crates/memcodec/derive/src/lib.rs && \
    mkdir -p crates/memcode/src && echo "// stub" > crates/memcode/src/lib.rs && \
    mkdir -p crates/memcode/core/src && echo "// stub" > crates/memcode/core/src/lib.rs && \
    mkdir -p crates/memcode/derive/src && echo "// stub" > crates/memcode/derive/src/lib.rs && \
    mkdir -p crates/memsecret/src && echo "// stub" > crates/memsecret/src/lib.rs && \
    mkdir -p crates/memvault/src && echo "// stub" > crates/memvault/src/lib.rs && \
    mkdir -p crates/memcrypt/src && echo "// stub" > crates/memcrypt/src/lib.rs && \
    mkdir -p crates/membench/src && echo "// stub" > crates/membench/src/lib.rs && \
    mkdir -p crates/membench/benches && echo "fn main() {}" > crates/membench/benches/aead.rs && \
    echo "fn main() {}" > crates/membench/benches/aead_aegis128l.rs && \
    echo "fn main() {}" > crates/membench/benches/cipherbox.rs && \
    echo "fn main() {}" > crates/membench/benches/codec.rs

# Pre-fetch dependencies
RUN cargo fetch

# Copy actual source code
COPY crates ./crates

# Print architecture info
RUN echo "=== Architecture Info ===" && \
    uname -m && \
    rustc --print cfg | grep -E "(target_arch|target_endian)"

# Run tests for the 3 target crates
CMD ["sh", "-c", "echo '=== Testing memutil ===' && cargo test -p memutil --release && \
     echo '=== Testing memcodec_core ===' && cargo test -p memcodec_core --release && \
     echo '=== Testing memaead ===' && cargo test -p memaead --release && \
     echo '=== ALL ARCH TESTS PASSED ==='"]
