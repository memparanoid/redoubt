# Cross-architecture test for redoubt-codec_core, redoubt-aead, redoubt-util
# Usage:
#   docker build --platform linux/amd64 -f docker/Dockerfile.arch-test -t redoubt-test-x86 .
#   docker build --platform linux/arm64 -f docker/Dockerfile.arch-test -t redoubt-test-arm .
#   docker build --platform linux/s390x -f docker/Dockerfile.arch-test -t redoubt-test-be .

FROM rust:bookworm

RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

# Copy workspace Cargo.toml and Cargo.lock
COPY Cargo.toml Cargo.lock ./

# Copy only the crates we need to test + their dependencies
COPY crates/redoubt-guard/Cargo.toml ./crates/redoubt-guard/
COPY crates/redoubt-alloc/Cargo.toml ./crates/redoubt-alloc/
COPY crates/redoubt-buffer/Cargo.toml ./crates/redoubt-buffer/
COPY crates/redoubt-zero/Cargo.toml ./crates/redoubt-zero/
COPY crates/redoubt-zero/core/Cargo.toml ./crates/redoubt-zero/core/
COPY crates/redoubt-zero/derive/Cargo.toml ./crates/redoubt-zero/derive/
COPY crates/redoubt-rand/Cargo.toml ./crates/redoubt-rand/
COPY crates/redoubt-util/Cargo.toml ./crates/redoubt-util/
COPY crates/redoubt-aead/Cargo.toml ./crates/redoubt-aead/
COPY crates/redoubt-codec/Cargo.toml ./crates/redoubt-codec/
COPY crates/redoubt-codec/core/Cargo.toml ./crates/redoubt-codec/core/
COPY crates/redoubt-codec/derive/Cargo.toml ./crates/redoubt-codec/derive/
COPY crates/redoubt-secret/Cargo.toml ./crates/redoubt-secret/
COPY crates/redoub-vault/Cargo.toml ./crates/redoub-vault/
COPY benchmarks/Cargo.toml ./benchmarks/
COPY crates/redoubt-test-utils/Cargo.toml ./crates/redoubt-test-utils/

# Create stub lib.rs files
RUN mkdir -p crates/redoubt-guard/src && echo "// stub" > crates/redoubt-guard/src/lib.rs && \
    mkdir -p crates/redoubt-alloc/src && echo "// stub" > crates/redoubt-alloc/src/lib.rs && \
    mkdir -p crates/redoubt-buffer/src && echo "// stub" > crates/redoubt-buffer/src/lib.rs && \
    mkdir -p crates/redoubt-zero/src && echo "// stub" > crates/redoubt-zero/src/lib.rs && \
    mkdir -p crates/redoubt-zero/core/src && echo "// stub" > crates/redoubt-zero/core/src/lib.rs && \
    mkdir -p crates/redoubt-zero/derive/src && echo "// stub" > crates/redoubt-zero/derive/src/lib.rs && \
    mkdir -p crates/redoubt-rand/src && echo "// stub" > crates/redoubt-rand/src/lib.rs && \
    mkdir -p crates/redoubt-util/src && echo "// stub" > crates/redoubt-util/src/lib.rs && \
    mkdir -p crates/redoubt-aead/src && echo "// stub" > crates/redoubt-aead/src/lib.rs && \
    mkdir -p crates/redoubt-codec/src && echo "// stub" > crates/redoubt-codec/src/lib.rs && \
    mkdir -p crates/redoubt-codec/core/src && echo "// stub" > crates/redoubt-codec/core/src/lib.rs && \
    mkdir -p crates/redoubt-codec/derive/src && echo "// stub" > crates/redoubt-codec/derive/src/lib.rs && \
    mkdir -p crates/redoubt-secret/src && echo "// stub" > crates/redoubt-secret/src/lib.rs && \
    mkdir -p crates/redoub-vault/src && echo "// stub" > crates/redoub-vault/src/lib.rs && \
    mkdir -p benchmarks/benches && echo "fn main() {}" > benchmarks/benches/aegis128l.rs && \
    echo "fn main() {}" > benchmarks/benches/xchacha20poly1305.rs && \
    echo "fn main() {}" > benchmarks/benches/redoubt-codec.rs && \
    echo "fn main() {}" > benchmarks/benches/cipherbox.rs && \
    echo "fn main() {}" > benchmarks/benches/page_buffer.rs && \
    mkdir -p crates/redoubt-test-utils/src && echo "// stub" > crates/redoubt-test-utils/src/lib.rs

# Pre-fetch dependencies
RUN cargo fetch

# Copy actual source code
COPY crates ./crates

# Print architecture info
RUN echo "=== Architecture Info ===" && \
    uname -m && \
    rustc --print cfg | grep -E "(target_arch|target_endian)"

# Run tests for the 3 target crates
CMD ["sh", "-c", "echo '=== Testing redoubt-util ===' && cargo test -p redoubt-util --release && \
     echo '=== Testing redoubt-codec_core ===' && cargo test -p redoubt-codec_core --release && \
     echo '=== Testing redoubt-aead ===' && cargo test -p redoubt-aead --release && \
     echo '=== Testing redoubt-buffer ===' && cargo test -p redoubt-buffer --release && \
     echo '=== ALL ARCH TESTS PASSED ==='"]
