# Cross-architecture test for memcodec_core, memaead, redoubt-util
# Usage:
#   docker build --platform linux/amd64 -f docker/Dockerfile.arch-test -t memora-test-x86 .
#   docker build --platform linux/arm64 -f docker/Dockerfile.arch-test -t memora-test-arm .
#   docker build --platform linux/s390x -f docker/Dockerfile.arch-test -t memora-test-be .

FROM rust:bookworm

RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

# Copy workspace Cargo.toml and Cargo.lock
COPY Cargo.toml Cargo.lock ./

# Copy only the crates we need to test + their dependencies
COPY crates/memguard/Cargo.toml ./crates/memguard/
COPY crates/memalloc/Cargo.toml ./crates/memalloc/
COPY crates/membuffer/Cargo.toml ./crates/membuffer/
COPY crates/memzer/Cargo.toml ./crates/memzer/
COPY crates/memzer/core/Cargo.toml ./crates/memzer/core/
COPY crates/memzer/derive/Cargo.toml ./crates/memzer/derive/
COPY crates/memrand/Cargo.toml ./crates/memrand/
COPY crates/redoubt-util/Cargo.toml ./crates/redoubt-util/
COPY crates/memaead/Cargo.toml ./crates/memaead/
COPY crates/memcodec/Cargo.toml ./crates/memcodec/
COPY crates/memcodec/core/Cargo.toml ./crates/memcodec/core/
COPY crates/memcodec/derive/Cargo.toml ./crates/memcodec/derive/
COPY crates/memsecret/Cargo.toml ./crates/memsecret/
COPY crates/memvault/Cargo.toml ./crates/memvault/
COPY benchmarks/Cargo.toml ./benchmarks/
COPY crates/mem_test_utils/Cargo.toml ./crates/mem_test_utils/

# Create stub lib.rs files
RUN mkdir -p crates/memguard/src && echo "// stub" > crates/memguard/src/lib.rs && \
    mkdir -p crates/memalloc/src && echo "// stub" > crates/memalloc/src/lib.rs && \
    mkdir -p crates/membuffer/src && echo "// stub" > crates/membuffer/src/lib.rs && \
    mkdir -p crates/memzer/src && echo "// stub" > crates/memzer/src/lib.rs && \
    mkdir -p crates/memzer/core/src && echo "// stub" > crates/memzer/core/src/lib.rs && \
    mkdir -p crates/memzer/derive/src && echo "// stub" > crates/memzer/derive/src/lib.rs && \
    mkdir -p crates/memrand/src && echo "// stub" > crates/memrand/src/lib.rs && \
    mkdir -p crates/redoubt-util/src && echo "// stub" > crates/redoubt-util/src/lib.rs && \
    mkdir -p crates/memaead/src && echo "// stub" > crates/memaead/src/lib.rs && \
    mkdir -p crates/memcodec/src && echo "// stub" > crates/memcodec/src/lib.rs && \
    mkdir -p crates/memcodec/core/src && echo "// stub" > crates/memcodec/core/src/lib.rs && \
    mkdir -p crates/memcodec/derive/src && echo "// stub" > crates/memcodec/derive/src/lib.rs && \
    mkdir -p crates/memsecret/src && echo "// stub" > crates/memsecret/src/lib.rs && \
    mkdir -p crates/memvault/src && echo "// stub" > crates/memvault/src/lib.rs && \
    mkdir -p benchmarks/benches && echo "fn main() {}" > benchmarks/benches/aegis128l.rs && \
    echo "fn main() {}" > benchmarks/benches/xchacha20poly1305.rs && \
    echo "fn main() {}" > benchmarks/benches/memcodec.rs && \
    echo "fn main() {}" > benchmarks/benches/cipherbox.rs && \
    echo "fn main() {}" > benchmarks/benches/page_buffer.rs && \
    mkdir -p crates/mem_test_utils/src && echo "// stub" > crates/mem_test_utils/src/lib.rs

# Pre-fetch dependencies
RUN cargo fetch

# Copy actual source code
COPY crates ./crates

# Print architecture info
RUN echo "=== Architecture Info ===" && \
    uname -m && \
    rustc --print cfg | grep -E "(target_arch|target_endian)"

# Run tests for the 3 target crates
CMD ["sh", "-c", "echo '=== Testing redoubt-util ===' && cargo test -p redoubt-util --release && \
     echo '=== Testing memcodec_core ===' && cargo test -p memcodec_core --release && \
     echo '=== Testing memaead ===' && cargo test -p memaead --release && \
     echo '=== Testing membuffer ===' && cargo test -p membuffer --release && \
     echo '=== ALL ARCH TESTS PASSED ==='"]
